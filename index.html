<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="/vite.svg" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vite App</title>
</head>

<body>
  <iframe id="flok" scrolling="no" frameborder="0"
    src="http://localhost:3000/s/memoria?layout=tidal,hydra&noHydra=1&bgOpacity=0" allow="geolocation"></iframe>

  <video id="video" loop muted crossorigin="anonymous" playsinline>
    <source src="/textures/examples_textures_kinect.webm">
  </video>

  <div id="three"></div>
  <canvas id="hydra" width="1920" height="1080"></canvas>
  <div id="error"></div>

  <script id="vs" type="x-shader/x-vertex">
    precision highp float;

    attribute float pindex;

    uniform sampler2D map;

    uniform float uRandom;
    uniform float uDepth;
    uniform float width;
    uniform float height;
    uniform float nearClipping, farClipping;

    uniform float pointSize;
    uniform float zOffset;

    varying vec2 vUv;

    const float XtoZ = 1.11146; // tan( 1.0144686 / 2.0 ) * 2.0;
    const float YtoZ = 0.83359; // tan( 0.7898090 / 2.0 ) * 2.0;


    float rand(vec2 co){
      return fract(sin(dot(co, vec2(12.9898, 78.233))) * 43758.5453);
    }


    void main() {
      vUv = vec2( position.x / width, position.y / height );

      // randomise
      vUv.xy += (vec2(rand(vUv.xy + vec2(pindex) + vec2(uRandom)), rand(vUv.yx + vec2(pindex) + vec2(uRandom))) - 0.5) * uDepth;

      vec4 color = texture2D( map, vUv );
      float depth = ( color.r + color.g + color.b ) / 3.0;

      // Projection code by @kcmic

      float z = ( 1.0 - depth ) * (farClipping - nearClipping) + nearClipping;

      vec4 pos = vec4(
        ( position.x / width - 0.5 ) * z * XtoZ,
        ( position.y / height - 0.5 ) * z * YtoZ,
        - z + zOffset,
        1.0);

      gl_PointSize = pointSize;
      gl_Position = projectionMatrix * modelViewMatrix * pos;

    }

  </script>

  <script id="fs" type="x-shader/x-fragment">

    uniform sampler2D map;
    uniform float clipX;
    uniform float clipY;
    uniform float clipWidthX;
    uniform float clipWidthY;
    uniform float time;
    uniform float hue;
    uniform float saturation;
    varying vec2 vUv;

    vec3 hsv2rgb(vec3 c)
    {
      vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);
      vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);
      return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);
    }

    void main() {

      vec4 color = texture2D( map, vUv );

      vec3 lineColorRgb = hsv2rgb(vec3(hue, saturation, 1.));
      vec4 lineColor = vec4(lineColorRgb, (color.r + color.g + color.b) / 3.);

      color *= step(clipX, vUv.x);
      color *= step(clipY, vUv.y);

      bool isClipXEdge = (vUv.x >= clipX) && (vUv.x <= clipX + clipWidthX - 0.001);
      bool isClipYEdge = (vUv.y >= clipY) && (vUv.y <= clipY + clipWidthY - 0.001);
      color = isClipXEdge || isClipYEdge ? lineColor : color;

      gl_FragColor = color;

    }

  </script>

  <script type="module" src="/src/main.js"></script>
</body>

</html>